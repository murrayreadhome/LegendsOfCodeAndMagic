// LegendsOfCodeAndMagic.cpp : Defines the entry point for the application.
//

#include "LegendsOfCodeAndMagic.h"
#include "GameController.h"
#include <chrono>
#include <conio.h>
#include <map>
#include "OldPlayers.h"

using namespace std;

vector<pair<int, Action>> op_actions;

double eval_new_vs_old(const Params& p, int n = 1000)
{
    int new_wins = 0;
    static int seed = int(std::chrono::duration_cast<std::chrono::milliseconds>(chrono::system_clock::now().time_since_epoch()).count());

    for (int i = 0; i < n / 2; i++)
    {
        {
            Player p1(p);
            OldPlayer1 p2(p);
            GameController gc(seed++);
            int winner = gc.play(p1, p2);
            if (winner == 0)
                new_wins++;
        }
        {
            OldPlayer1 p1(p);
            Player p2(p);
            GameController gc(seed++);
            int winner = gc.play(p1, p2);
            if (winner == 1)
                new_wins++;
        }
    }

    return double(new_wins) / n;
}

double eval_params(const Params& a, const Params& b, int n=1000)
{
    int a_wins = 0;
    static int seed = int(std::chrono::duration_cast<std::chrono::milliseconds>(chrono::system_clock::now().time_since_epoch()).count());

    for (int i = 0; i < n/2; i++)
    {
        for (int o = 0; o < 2; o++)
        {
            OldPlayer1 p1(o ? b : a);
            OldPlayer1 p2(o ? a : b);
            GameController gc(seed++);
            int winner = gc.play(p1, p2);
            if (winner == o)
                a_wins++;
        }
    }

    return double(a_wins) / n;
}

double eval_params(const Params& a, const vector<Params>& b, int n = 1000)
{
    double worst = 1.0;
    for (const Params& op : b)
        worst = min(worst, eval_params(a, op, n));
    return worst;
}

void mutate_params(Params& p, mt19937& re)
{
    do
    {
        size_t ni = sizeof(p.i) / sizeof(int);
        size_t nd = sizeof(p.d) / sizeof(double);
        size_t n = uniform_int_distribution<size_t>(0, ni + nd - 1)(re);
        if (n < ni)
        {
            int& i = reinterpret_cast<int*>(&p.i)[n];
            i += uniform_int_distribution<int>(-2, 2)(re);
        }
        else
        {
            n -= ni;
            double& d = reinterpret_cast<double*>(&p.d)[n];
            if (uniform_int_distribution<size_t>(0, 1)(re) == 0)
                d += uniform_real_distribution<double>(-1.0, 1.0)(re);
            else
                d *= exp(uniform_real_distribution<double>(-1.0, 1.0)(re));
        }
    } while (uniform_int_distribution<size_t>(0, 1)(re) == 0);
}

ostream& operator<<(ostream& out, const Params& p)
{
    size_t ni = sizeof(p.i) / sizeof(int);
    size_t nd = sizeof(p.d) / sizeof(double);
    const int* pi = reinterpret_cast<const int*>(&p.i);
    const double* pd = reinterpret_cast<const double*>(&p.d);

    const char* eon = "       \n";
    out << "{{" << endl;
    for (int i = 0; i < ni; i++)
        out << pi[i] << "," << eon[i%8];
    out << "\n},\n{" << endl;
    for (int i = 0; i < nd; i++)
        out << pd[i] << "," << eon[i%8];
    out << "\n}};" << endl;

    return out;
}

void improve_params(Params p, const vector<Params>& vs)
{
    int seed = int(std::chrono::duration_cast<std::chrono::milliseconds>(chrono::system_clock::now().time_since_epoch()).count());
    mt19937 re(seed);
    double bestSc = eval_params(p, vs);
    size_t n = 1;
    map<size_t, pair<Params, double>> ltBest;
    size_t last_revert = 0;
    double last_revert_sc = bestSc;

    while (!_kbhit())
    {
        Params q = p;
        mutate_params(q, re);
        double scq = 0, tscq = 0;
        size_t qn = 0;
        for (size_t i = 0; i < n; i++)
        {
            tscq += eval_params(q, vs);
            qn++;
            scq = tscq / qn;
            if (scq < bestSc)
                break;
        }
        double scp = eval_params(p, vs);
        bestSc = (bestSc * n + scp) / (n + 1);
        n++;
        cerr << scq << " vs " << bestSc << " / " << n << endl;
        if (scq >= bestSc || uniform_int_distribution<int>(0, 20)(re) == 0)
        {
            last_revert = 0;
            p = q;
            n = qn;
            if (scq > bestSc)
            {
                cout << q;
                bestSc = scq;
            }
        }

        if (last_revert != 0)
        {
//            cerr << "update " << last_revert << endl;
            ltBest[last_revert].second = bestSc;
        }

        if (n != 0 && (n % 4) == 0)
        {
//            cout << "check best for " << n << endl;
            if (bestSc > ltBest[n].second)
            {
                ltBest[n] = { p, bestSc };
            }
        }

        if (!ltBest.empty() && (bestSc + 0.05 < last_revert_sc || n > 32 || uniform_int_distribution<size_t>(0, n*2)(re) == 0))
        {
            size_t r = uniform_int_distribution<size_t>(0, ltBest.size() - 1)(re);
            size_t rn = 4 * (r + 1);
//            cout << "check update" << ltBest.size() << " " << r << " " << rn << endl;
//            for (auto x : ltBest) cout << x.first << "->" << x.second.second << endl;
            last_revert = rn;
            if (bestSc < ltBest[rn].second)
            {
                p = ltBest[rn].first;
                n = rn;
                if (n > 32)
                    n -= 16;
                bestSc = ltBest[rn].second;
                last_revert_sc = bestSc;
                ltBest[rn].second -= 0.001;
                cout << "revert to lt best " << bestSc << " / " << rn << endl;
                cout << p;
            }
        }
    }

    for (const auto& lt : ltBest)
    {
        cout << "n=" << lt.first << " score=" << lt.second.second << endl;
        cout << lt.second.first;
    }
}

void tournament(const vector<Params>& params)
{
    size_t n = params.size();
    vector<double> scores(n, 0);
    for (size_t i = 0; i < n; i++)
    {
        for (size_t j = i + 1; j < n; j++)
        {
            double i_wins = eval_params(params[i], params[j], 10000);
            cout << i << " vs " << j << " " << i_wins << endl;
            scores[i] += i_wins;
            scores[j] += 1.0 - i_wins;
        }
    }

    for (size_t i = 0; i < n; i++)
        cout << i << " " << scores[i]/(n-1) << endl;
}

/* previous invalid
    Params gold32 =
    { {
2, 9, 11, 9, 7, 4, 3, -2,
-3, 0, 4, 5, 2,
},
{
7.73817, 2.91513, 0.42475, 4.77937, -0.826599, 0.691071, 0.729992, -3.01847,
-5.33083, 4.26642, 4.8868, 2.18347, 1.09028, 2.01672, 1.89978, 3.09518,
1.35242, 4.52741, 3.01027, 0.144965, -0.440247, 4.34497, 5.36517, 0,
-4.13682, 0.775486, -2.53257, 0.964975, -2.90551, -3.59518, -2.44149, -1.07429,
2.50147, 0.327159, -2.1511, -2.62134, 4.22959, 1.87049, -2.11927, 0, 0, 0.327159, -2.1511, -2.62134, 4.22959, 1.87049, -2.11927,
} };

    Params prev =
    { {
    -3, 5, 6, 4, 2, 2, -3, -1,
    -1, 0, -1, 2, -4,
    },
    {
    4.79313, 1.17399, 0.424348, 4.70863, -0.796309, 0.0514385, 1.17727, -2.0296,
    1.59741, 0.485915, 0.602749, 0.102713, -2.07307, -1.08749, 0.890888, 1.43694,
    -0.0226625, 0.491488, 0.651959, 0.117335, -1.13037, 1.31927, 1.42461, 0,
    -0.97392, -0.973255, -0.627406, 0, 0.218332, -0.0336394, 4.79313, 1.17399,
    0.424348, -2.0296, 1.59741, 0.485915, 0.602749, 0.102713, -2.07307,
    } };

    Params gold57=
    { {
2, 3, 5, 5, 3, 2, 2, -2,
-5, -2, -1, 0, -2,
},
{
2.69287, 1.93944, 0.218916, 0.954512, -1.04002, 0.99281, 4.60915, -1.16954,
2.53758, 2.43279, 0.635511, 4.82829, 2.74237, 0.634413, -0.941901, 4.66539,
2.1327, -2.81415, 1.3494, 0.174386, -2.43276, 1.75129, 1.93385, 0,
1.97353, 0.584058, 2.94098, -0.893542, 7.60946, 1.6964, 3.13547, 1.5531,
0.703979, -3.93893, -1.93636, -4.59371, 0.132084, 8.15254, -2.93104, 0, 0,  -3.93893, -1.93636, -4.59371, 0.132084, 8.15254, -2.93104,
} };

    Params gold56 =
    { {
-6, 6, 9, 9, 7, 6, 4, 4,
6, -8, 0, 4, -7,
},
{
8.25737, 3.45518, 0.568089, 0.0932142, -1.04358, 0.98962, 8.93013, -0.201248,
0.0830147, 1.89789, 3.23594, 6.99142, 2.3462, -1.91313, 4.03476, 8.45027,
-3.43596, 1.16945, 2.50136, 0.975953, 0.321074, 2.11444, 1.59877, 0,
0.394601, 6.98325, 2.68533, -8.51471, 12.2219, 1.04509, 7.00152, 1.48917,
0.303177, 1.8464, -2.42281, -3.00746, 0.320811, 7.63241, 0.196139, 1.2679,
1.39347, -7.002, -0.217405, -0.640002, 1.04721, 4.44642, 2.53409, -1.544,
2.54769, 2.59733, -3.83357, 2.70376, 1.19074, -0.286425, -0.0729417, -2.06092,
3.54413,
} };
    Params gold31 =
    { {
    7, 6, 12, 10, 10, 8, 6, 4,
    5, -10, -10, 5, -4,
    },
    {
    7.61404, 6.73621, 0.00703978, -0.605314, -1.18427, -25.1146, 0.726403, -0.719495,
    4.99645, 0.130773, 0.244524, 0.974274, 0.0252914, -0.709927, 0.97464, 0.737504,
    -1.5623, -5.09058, -1.53143, 0.224828, -0.0458732, 1.22855, 1.57064, 0,
    2.83786, 4.61971, 0.2521, 2.94954, 15.5086, 3.53728, 0.690261, -1.44891,
    2.04015, -0.983451, -1.55338, 2.19156, 3.15911, 9.07261, -0.884952, 0.727166,
    1.26622, -62.8933, -6.71968, -0.970392, -9.02535, -0.597951, 1.06167, -1.37738,
    3.29726, 9.94, -2.68016, 1.65906, 0.378562, 2.34008, 0.0208961, -1.55224,
    0.236862,
    } };

        Params gold27 = 
    { {
    0, 2, 4, 5, 2, 1, -5, -7,
    -5, -11, -8, -7, -7,
    },
    {
    2.80787, 1.9218, 0.261229, 0.725032, -1.28739, 0.830066, 0.567213, -0.414187,
    1.45776, -0.272006, 0.575817, -0.25395, 2.73163, -0.313109, 3.85514, 0.872998,
    1.56796, 1.64741, 1.14193, -0.157035, 0.0580965, 1.1822, 1.53493, 0,
    0.638911, -1.02047, -0.346689, -0.762542, 19.8183, -1.02183, 1.14937, 0.560557,
    2.94441, -4.74371, -3.15498, -0.573178, 0.0780187, -0.0281649, 3.60422, -0.00324518,
    3.98431, -1.02113, -1.79464, 1.22999, 0.568018, 1.63991, -0.468817, 0.186743,
    6.42454, 14.9243, -0.0170047, 6.03354, -2.36409, -2.46361, -0.550072, -0.497079,
    25.1896, 0, 0.0723614, -0.216477, -0.0144239,
    } };

    Params gold29 =
    { {
    -10, 4, 5, 5, 3, 1, -2, -1,
    0, -1, -1, -6, -5,
    },
    {
    4.48682, 0.814388, 0.937428, 0.954993, -0.945402, 0.790389, 0.299937, 0.652758,
    0.502391, 0.563479, 2.4234, 9.29261, 0.455452, 0.32669, -1.22316, -1.16814,
    -0.808896, -0.43114, -0.0490446, -0.0956106, -0.188912, 0.804913, 1.02183, 0,
    0.472189, 0.34489, 0.125312, -0.414577, -0.0399419, 1.82381, 1.78481, 0.548026,
    1.5848, 0.92391, -1.94682, -2.53886, 1.91067, 21.3365, -0.110678, 1.838,
    3.73184, -3.50746, 6.71453, -4.03034, 0.140442, -0.331771, -1.88739, -0.616496,
    1.07745, 10.1477, -0.689676, 3.07892, -0.110182, 1.23771, 0.262264, -4.02499,
    50.4201, 0.656469, 0.597189, -2.27736, -2.63299,
    } };

    Params gold54 =
    { {
    -3, 3, 4, 3, 2, 2, 2, -1,
    -10, -1, 6, 2, 0,
    },
    {
    5.98064, 3.1375, 0.17387, 0.910113, -1.35529, 1.07784, 0.795772, 0.851223,
    0.93856, 1.73916, -0.80664, 9.39853, 0.91713, -1.2884, 10.1881, 0.0019517,
    0.540373, 4.21818, -1.01121, 0.191074, 0.00711617, 1.41855, 0.987965, 0,
    0.687402, -2.02204, 1.38237, -0.586791, 5.04337, -1.8773, 11.1439, 1.74638,
    0.178762, -0.380358, 4.1251, -2.65884, 2.61246, 1.02642, 2.74289, 0.459122,
    -0.110867, -0.028575, -0.193553, -0.868642, 1.58013, -0.136053, 1.11242, -0.279358,
    -0.235957, 5.32766, 0.888198, 5.86476, -0.322907, 0.229661, 0.238355, 1.19933,
    3.78986, -3.07437, -0.324911, 0.729749, 0.721002,
    } };

    Params gold51 =
    { {
    -2, 4, 7, 6, 4, 3, 2, -2,
    3, -4, -2, 1, -6,
    },
    {
    2.92758, 2.32331, 0.134682, -0.273991, -1.69813, 0.829984, 0.26992, -0.133901,
    1.71969, 1.11473, 1.84153, 6.12891, 0.398056, 0.548613, 0.540899, 0.987937,
    1.26183, 0.798109, -1.785, -0.341254, -2.95235, 2.24935, 3.03517, 0,
    0.669813, -0.595485, -0.861745, 1.08218, 0.537901, -0.29153, -1.23387, 0.148897,
    4.79304, 3.04382, 0.64142, -0.303951, 0.245083, -0.252056, -0.283696, -1.23986,
    0.438194, 0.244324, -0.4476, 1.29697, 0.658796, -0.123863, 0.404009, 0.0259836,
    6.95938, 8.51775, -3.85391, 3.64061, 0.18202, -0.183716, -0.432416, 1.81837,
    15.3711, 0, 0.280258, 6.47732, -4.14558,
    } };

    Params gold26 =
    { {
    1, 4, 6, 5, 3, 2, -9, -1,
    -5, -3, -4, -1, -1,
    },
    {
    4.07268, 2.8635, 0.24436, 0.275285, -0.934957, 0.578424, 0.475535, 0.80735,
    0.970358, -0.38335, 0.0743804, 5.25768, -0.853011, -0.305284, 3.30236, 1.60702,
    -0.254632, 2.10599, 17.7768, 0.0445463, 0.0462376, 1.39809, 1.51758, 0,
    2.03367, -0.481369, -1.4914, 0.131085, 0.148271, -0.377966, 1.62126, 0.362001,
    2.50488, -4.71992, 0.160487, 0.197257, -1.08914, 25.3655, 0.310375, 1.86061,
    1.86515, 0.678516, -15.1084, -2.3648, 0.143622, -0.823574, 1.74447, -2.17074,
    0.85289, 12.7331, -0.441739, 0.727032, 1.34889, -0.0152078, -0.654388, 0.253742,
    3.40774, 0, 0.614939, 4.12959, -1.21714,
    } };

*/

int main()
{
    Params gold9 =
    { {
    1, 4, 6, 5, 3, 2, -11, -1,
    -1, -5, -3, -1, -1,
    },
    {
    4.07268, 2.8635, 0.24436, 0.275285, -0.934413, 0.578424, 0.368178, 0.324054,
    0.970358, -1.14051, 0.0743804, 4.39096, -1.6284, 0.554772, 3.12684, 1.88235,
    -0.0194372, 2.47201, 6.24481, 0.0275378, 0.0462376, 1.39809, 1.51758, 0,
    2.26445, -0.481369, -2.25398, 0.319278, -0.418014, -0.492748, 2.2012, 0.554911,
    1.884, -4.71992, 0.414974, -0.71358, -1.08914, 26.1421, 0.310375, 7.17221,
    2.37614, 0.588487, -7.20572, -1.66024, 0.957726, -1.06389, 1.16537, -1.97045,
    2.57761, 12.7331, -0.441739, 1.1968, 1.0257, -0.239832, -0.884526, 0.87699,
    3.40774, 0, 0.198644, 3.98853, -1.21714,
    } };

    Params gold2 =
    { {
    -5, 3, 5, 4, 2, -1, -13, 1,
    -5, -7, 5, -12, -4,
    },
    {
    4.73095, 2.68304, 0.236421, 0.717338, -1.03961, 0.883133, 0.0994785, 1.18619,
    2.16072, 2.70415, 0.693665, 17.6778, 11.3714, -0.958515, -2.40779, 3.2706,
    -0.790726, -2.26678, -1.96172, 0.152949, 0.0641518, 2.30234, 2.53189, 0,
    -1.63735, 0.337842, -0.468753, -0.299272, -1.83165, -1.70411, 4.95859, 1.15357,
    0.352331, -1.48017, 0.215066, -3.63714, -0.73088, 107.654, 12.4766, 2.23271,
    -0.0201277, 2.25825, -3.23735, -0.690174, -2.29374, -3.93088, -1.13206, -0.90098,
    4.96106, 8.88133, -3.21313, 2.45326, -0.213814, 0.12347, -6.4973, 5.5528,
    5.10403, 0.357561, 2.78479, -0.42423, 0.751112, 0.499989, -4.67846,
    } };

    Params current =
    {};

    improve_params(current, { gold9, gold2 });
    //tournament({ gold27, gold29, gold54, gold51, gold26, current });
    //cout << eval_new_vs_old(gold23, 1000);
	return 0;
}
